# 活体检测功能使用说明

## 概述

活体检测（Liveness Detection）是一种用于验证摄像头前是否为真人的技术，可以有效防止使用照片、视频或其他欺骗手段进行身份伪造。本项目提供了基于 MediaPipe 的活体检测实现。

## 功能特性

### 检测方法
1. **眨眼检测** - 检测用户是否进行了自然的眨眼动作
2. **头部运动分析** - 分析头部的微小运动模式
3. **面部纹理分析** - 检测面部纹理的真实性
4. **综合评分** - 结合多种指标给出最终判断

### 检测状态
- `PROCESSING` - 检测进行中
- `REAL` - 检测到真人
- `FAKE` - 检测到假人/照片
- `UNKNOWN` - 无法确定

## 使用方法

### 1. 独立使用活体检测模块

```python
from liveness_detection import LivenessDetector, LivenessStatus
import cv2

# 创建检测器
detector = LivenessDetector()

# 打开摄像头
cap = cv2.VideoCapture(0)

while True:
    ret, frame = cap.read()
    if not ret:
        break
    
    # 执行活体检测
    result = detector.detect_liveness(frame)
    
    # 绘制检测信息
    frame_with_info = detector.draw_liveness_info(frame, result)
    
    # 显示结果
    cv2.imshow('Liveness Detection', frame_with_info)
    
    # 检测完成时退出
    if result.status != LivenessStatus.PROCESSING:
        print(f"检测结果: {result.status.value}")
        print(f"置信度: {result.confidence:.3f}")
        break
    
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
```

### 2. 使用集成GUI应用

#### 启动应用
```bash
python face_detect_with_liveness_gui.py
```

#### 操作步骤
1. 点击"活体检测"选项卡
2. 点击"启动摄像头"按钮
3. 确保面部在摄像头视野内
4. 点击"开始活体检测"按钮
5. 在5秒内完成以下动作：
   - 眨眼3次以上
   - 轻微转动头部
6. 等待检测结果
7. 可选择保存检测结果

## 检测参数配置

### LivenessDetector 参数

```python
detector = LivenessDetector(
    detection_duration=5.0,    # 检测持续时间（秒）
    min_blinks=3,             # 最少眨眼次数
    confidence_threshold=0.7,  # 置信度阈值
    ear_threshold=0.25,       # 眼部纵横比阈值
    movement_threshold=0.02    # 头部运动阈值
)
```

### 参数说明
- `detection_duration`: 活体检测的总时长，默认5秒
- `min_blinks`: 检测期间要求的最少眨眼次数
- `confidence_threshold`: 判断为真人的置信度阈值
- `ear_threshold`: 眼部纵横比阈值，用于眨眼检测
- `movement_threshold`: 头部运动的敏感度阈值

## 检测结果解读

### LivenessResult 对象

```python
class LivenessResult:
    status: LivenessStatus          # 检测状态
    confidence: float               # 置信度 (0.0-1.0)
    blink_count: int               # 眨眼次数
    head_movement_score: float     # 头部运动得分
    texture_score: float           # 纹理得分
    timestamp: str                 # 检测时间戳
    details: Dict[str, Any]        # 详细信息
```

### 置信度解读
- `0.8-1.0`: 高置信度，强烈建议为真人
- `0.6-0.8`: 中等置信度，可能为真人
- `0.4-0.6`: 低置信度，需要额外验证
- `0.0-0.4`: 很低置信度，可能为假人

## 最佳实践

### 环境要求
1. **光线充足** - 确保面部有足够的光照
2. **摄像头质量** - 使用清晰度较高的摄像头
3. **稳定环境** - 避免强烈的背景光或反光
4. **距离适中** - 保持面部在摄像头1-2米范围内

### 用户指导
1. **面部居中** - 确保整个面部在摄像头视野内
2. **自然表情** - 保持自然的面部表情
3. **配合动作** - 按要求完成眨眼和轻微头部运动
4. **避免遮挡** - 不要用手或其他物体遮挡面部

### 安全建议
1. **多重验证** - 结合其他身份验证方法
2. **阈值调整** - 根据应用场景调整置信度阈值
3. **日志记录** - 记录检测结果用于安全审计
4. **定期更新** - 保持检测算法的更新

## 常见问题

### Q: 检测总是失败怎么办？
A: 检查以下几点：
- 光线是否充足
- 摄像头是否正常工作
- 面部是否完全在视野内
- 是否按要求完成了眨眼动作

### Q: 检测时间太长怎么办？
A: 可以调整 `detection_duration` 参数，但建议不要低于3秒，以确保检测准确性。

### Q: 误判率较高怎么办？
A: 可以尝试：
- 调整 `confidence_threshold` 阈值
- 改善检测环境的光线条件
- 使用更高质量的摄像头
- 增加检测时长

### Q: 如何提高检测准确性？
A: 建议：
- 使用多种检测方法组合
- 收集更多训练数据
- 针对特定场景调整参数
- 结合其他生物识别技术

## 技术原理

### 眨眼检测
使用眼部关键点计算眼部纵横比（EAR），通过EAR的变化检测眨眼动作。

### 头部运动分析
跟踪面部关键点的位置变化，分析头部的微小运动模式。

### 纹理分析
分析面部区域的纹理特征，区分真实皮肤和照片/屏幕显示。

### 综合评分
结合多个指标，使用加权平均的方式计算最终的活体检测置信度。

## 性能优化

### 计算优化
- 降低检测频率以减少CPU使用
- 使用GPU加速（如果可用）
- 优化图像预处理流程

### 内存优化
- 及时释放不需要的图像数据
- 控制历史数据的存储量
- 使用适当的图像分辨率

## 扩展功能

### 自定义检测算法
可以继承 `LivenessDetector` 类，实现自定义的检测算法：

```python
class CustomLivenessDetector(LivenessDetector):
    def detect_liveness(self, frame):
        # 实现自定义检测逻辑
        result = super().detect_liveness(frame)
        # 添加额外的检测步骤
        return result
```

### 数据收集
可以保存检测过程中的数据用于算法改进：

```python
# 保存检测数据
detector.save_detection_data = True
detector.data_save_path = "./detection_data/"
```

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 基础活体检测功能
- GUI集成
- 眨眼检测
- 头部运动分析
- 纹理分析

## 技术支持

如果在使用过程中遇到问题，请：
1. 查看本文档的常见问题部分
2. 检查系统环境和依赖安装
3. 查看应用日志获取错误信息
4. 提供详细的错误描述和复现步骤

---

**注意**: 活体检测技术仍在不断发展中，本实现主要用于学习和研究目的。在生产环境中使用时，建议结合多种验证方法以提高安全性。